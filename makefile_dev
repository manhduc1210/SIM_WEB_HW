CC ?= $(CROSS_COMPILE)gcc
SRC_DIRS := hal/src unity/src osal/src
INC_DIRS := hal/include unity/include osal/include
OBJ_DIR  := out
# TEST_DIR  := src_unit_test/auto
# Test files
TEST_GPIO_SRC  := src_unit_test/manual/test_hal_gpio_linux.c
TEST_UART_SRC  := src_unit_test/manual/test_hal_uart_linux.c
TEST_I2C_SRC   := src_unit_test/manual/test_hal_i2c_linux.c
TEST_SPI_SRC   := src_unit_test/manual/test_hal_spi_linux.c

TEST_OSAL_SRC  := src_unit_test/osal/test_osal_task_linux.c

# Binary output
TEST_GPIO_BIN  := test_gpio
TEST_UART_BIN  := test_uart
TEST_I2C_BIN   := test_i2c
TEST_SPI_BIN   := test_spi
TEST_OSAL_BIN  := test_osal

# libgpiod flags (Æ°u tiÃªn pkg-config cá»§a SDK; náº¿u khÃ´ng cÃ³ thÃ¬ fallback -I/-L)
GPIOD_CFLAGS := $(shell pkg-config --cflags gpiod 2>/dev/null)
GPIOD_LIBS   := $(shell pkg-config --libs   gpiod 2>/dev/null)
ifeq ($(strip $(GPIOD_LIBS)),)
  ifneq ($(strip $(SDKTARGETSYSROOT)),)
    GPIOD_CFLAGS += -I$(SDKTARGETSYSROOT)/usr/include
    GPIOD_LIBS   += -L$(SDKTARGETSYSROOT)/usr/lib -lgpiod
    GPIOD_LIBS   += -lutil
  else
    GPIOD_LIBS   += -lgpiod
    GPIOD_LIBS   += -lutil
  endif
endif

# Flags
INC_FLAGS := $(addprefix -I,$(INC_DIRS))
CFLAGS  ?= -O2
CFLAGS  += -Wall -pthread $(INC_FLAGS) $(GPIOD_CFLAGS)
CFLAGS  += -DUNITY_INCLUDE_VERBOSE
LDFLAGS ?=
LDFLAGS += -pthread $(GPIOD_LIBS)

# Náº¿u build Ä‘á»ƒ Ä‘o coverage: make COVERAGE=1
ifeq ($(COVERAGE),1)
  CFLAGS  += --coverage
  LDFLAGS += --coverage
endif

# Debug (make DEBUG=1)
ifeq ($(DEBUG),1)
  CFLAGS += -g -DDEBUG
endif

# Sources & Objects
SRCS := $(foreach d,$(SRC_DIRS),$(wildcard $(d)/*.c))
OBJS := $(patsubst %.c,$(OBJ_DIR)/%.o,$(SRCS))

# =========================
# Default
# =========================
all: $(TEST_GPIO_BIN) $(TEST_OSAL_BIN) $(TEST_UART_BIN) $(TEST_I2C_BIN) $(TEST_SPI_BIN)

# =========================
# Build UART test
# =========================
$(TEST_UART_BIN): $(OBJS) $(TEST_UART_SRC)
	@echo "ðŸ”§ Building $@ ..."
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)

# =========================
# Build I2C test
# =========================
$(TEST_I2C_BIN): $(OBJS) $(TEST_I2C_SRC)
	@echo "ðŸ”§ Building $@ ..."
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)

# =========================
# Build SPI test
# =========================
$(TEST_SPI_BIN): $(OBJS) $(TEST_SPI_SRC)
	@echo "ðŸ”§ Building $@ ..."
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)

# =========================
# Build GPIO test
# =========================
$(TEST_GPIO_BIN): $(OBJS) $(TEST_GPIO_SRC)
	@echo "ðŸ”§ Building $@ ..."
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)

# =========================
# Build OSAL test
# =========================
$(TEST_OSAL_BIN): $(OBJS) $(TEST_OSAL_SRC)
	@echo "ðŸ”§ Building $@ ..."
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)

# =========================
# Compile .c -> out/.../.o
# =========================
$(OBJ_DIR)/%.o: %.c
	@echo "ðŸ§© Compiling $< ..."
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) -c $< -o $@

# =========================
# Run tests
# =========================

test-gpio: $(TEST_GPIO_BIN)
	@echo "ðŸš€ Running GPIO test..."
	./$(TEST_GPIO_BIN) || true

test-uart: $(TEST_UART_BIN)
	@echo "ðŸš€ Running UART test..."
	./$(TEST_UART_BIN) || true

test-i2c: $(TEST_I2C_BIN)
	@echo "ðŸš€ Running I2C test..."
	./$(TEST_I2C_BIN) || true

test-spi: $(TEST_SPI_BIN)
	@echo "ðŸš€ Running SPI test..."
	./$(TEST_SPI_BIN) || true

test-osal: $(TEST_OSAL_BIN)
	@echo "ðŸš€ Running OSAL test..."
	./$(TEST_OSAL_BIN) || true

test-all: test-logic test-gpio test-osal test-i2c test-spi

# =========================
# Coverage
# =========================
coverage: test-all
	@echo "ðŸ“Š Generating coverage report ..."
	lcov --capture --directory . --output-file coverage.info
	lcov --remove coverage.info '/usr/*' --output-file coverage.info
	genhtml coverage.info --output-directory coverage_html
	@echo "âž¡  Open coverage_html/index.html"

# =========================
# Clean
# =========================
clean:
	@echo "ðŸ§¹ Cleaning ..."
	rm -rf $(OBJ_DIR) $(TEST_GPIO_BIN) $(TEST_OSAL_BIN) $(TEST_UART_BIN) $(TEST_I2C_BIN) $(TEST_SPI_BIN)
	rm -f *.gcno *.gcda *.info
	rm -rf coverage_html

.PHONY: all clean test-logic test-gpio test-all coverage
